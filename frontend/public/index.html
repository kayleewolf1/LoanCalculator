<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Calculator</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
    <div class="container">
        <h1>Loan Calculator</h1>
        <form id="loanForm">
            <div class="form-group">
                <label for="loanAmount">Loan Amount ($)</label>
                <input type="text" id="loanAmount" name="loanAmount" placeholder="Enter loan amount">
                <div class="error" id="loanAmountError"></div>
            </div>

            <div class="form-group">
                <label for="purchasePrice">Purchase Price ($)</label>
                <input type="text" id="purchasePrice" name="purchasePrice" placeholder="Enter purchase price">
                <div class="error" id="purchasePriceError"></div>
            </div>

            <div class="form-group">
                <label for="ltv">LTV (%)</label>
                <input type="text" id="ltv" name="ltv" placeholder="Enter LTV">
                <div class="error" id="ltvError"></div>
            </div>

            <div class="form-group">
                <label for="fico">FICO Score</label>
                <input type="number" id="fico" name="fico" placeholder="Enter FICO score" min="300" max="850">
                <div class="error" id="ficoError"></div>
            </div>

            <div class="form-group">
                <label for="propertyType">Property Type</label>
                <select id="propertyType" name="propertyType">
                    <option value="single-family">Single Family</option>
                    <option value="multi-family">Multi Family</option>
                    <option value="condo">Condo</option>
                    <option value="townhouse">Townhouse</option>
                    <option value="manufactured">Manufactured</option>
                    <option value="commercial">Commercial</option>
                </select>
            </div>

            <div class="form-group">
                <label for="state">State</label>
                <select id="state" name="state">
                    <option value="">Select a state</option>
                </select>
                <div class="error" id="stateError"></div>
            </div>

          
            <div class="form-group">
                <label for="loanType">Loan Type</label>
                <input type="text" id="loanType" name="loanType" placeholder="Enter loan type (e.g., '15-Year Fixed Rate')">
                <div class="error" id="loanTypeError"></div>
            </div>

            <button type="submit">Calculate</button>
            <button type="button" id="searchButton">Search</button>

            <div id="matchingLoansTable" style="display: none;">
                <h2>Matching Loan Types:</h2>
                <div class="results-grid">
                    <div class="result-item" id="matchingLoanTypes"></div>
                </div>
            </div>

            <div id="results" style="display: none;">
                <h2>Results:</h2>
                <div class="results-grid">
                    <div class="result-item" id="resultLoanAmount"></div>
                    <div class="result-item" id="resultPurchasePrice"></div>
                    <div class="result-item" id="resultLTV"></div>
                    <div class="result-item" id="resultFICO"></div>
                    <div class="result-item" id="resultPropertyType"></div>
                    <div class="result-item" id="resultState"></div>
                </div>
            </div>
        </form>
    </div>


    <script type="module">
        import PricingService from './pricingService.js';

        // Initialize the PricingService
        const pricingService = PricingService;

        // Load the pricing data when the page is loaded
        async function initializePricingService() {
            try {
                await pricingService.loadLocalData();
                console.log('Pricing data loaded successfully:', pricingService.localData);
            } catch (error) {
                console.error('Error loading pricing data:', error);
            }
        }

        // Call the initialization function
        initializePricingService();



        // List of US states with full names
        const statesList = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
            'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
            'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
            'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
            'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
            'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
            'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
            'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
            'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
            'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        // Populate states dropdown
        const stateSelect = document.getElementById('state');
        Object.entries(statesList).forEach(([abbr, name]) => {
            const option = document.createElement('option');
            option.value = abbr;
            option.textContent = `${abbr} - ${name}`;
            stateSelect.appendChild(option);
        });

        

        function calculateLoanAmount() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value.replace(/,/g, '')) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value.replace(/,/g, '')) || 0;
            const ltv = parseFloat(document.getElementById('ltv').value.replace(/,/g, '')) || 0;

            if (purchasePrice > 0) {
                if (ltv) {
                    // Calculate loan amount whenever LTV changes
                    const calculatedLoanAmount = (purchasePrice * (parseFloat(ltv) / 100)).toFixed(2);
                    if (!document.getElementById('loanAmount').matches(':focus')) {
                        document.getElementById('loanAmount').value = parseFloat(calculatedLoanAmount).toLocaleString();
                    }
                }
            }
        }

        function calculateltv() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value.replace(/,/g, '')) || 0;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value.replace(/,/g, '')) || 0;
            var calculatedLTV = "";

            if(purchasePrice !== 0 && loanAmount !== 0) {
                calculatedLTV = ((loanAmount / purchasePrice) * 100).toFixed(2);
            }
            
            document.getElementById('ltv').value = calculatedLTV;
        }

        // Add event listeners
        document.getElementById('loanAmount').addEventListener('input', function() {
            formatCurrency(this);
            console.log("loan amount event listener - input ");
            calculateltv();
        });

        document.getElementById('purchasePrice').addEventListener('input', function() {
            formatCurrency(this);
            console.log("purchase price event listener - input ");
            calculateltv();
        });

        document.getElementById('ltv').addEventListener('input', function() {
            let value = this.value.replace(/[^\d.]/g, '');
            const decimalPoints = value.match(/\./g);
            if (decimalPoints && decimalPoints.length > 1) {
                value = value.replace(/\./, '');
            }
            this.value = value;
            
            if (document.getElementById('purchasePrice').value) {
                calculateLoanAmount();
            }
        });

        function formatCurrency(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value.length > 0) {
                value = parseInt(value).toLocaleString();
            }
            input.value = value;
        }

        // Form validation and submission
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error').forEach(error => error.textContent = '');

            // Get form values
            const values = {
                purchasePrice: document.getElementById('purchasePrice').value,
                loanAmount: document.getElementById('loanAmount').value,
                ltv: document.getElementById('ltv').value,
                fico: document.getElementById('fico').value,
                state: document.getElementById('state').value
            };

            // Validate Purchase Price (required)
            if (!values.purchasePrice) {
                document.getElementById('purchasePriceError').textContent = 'Purchase price is required';
                isValid = false;
            }

            // Validate that at least loan amount OR LTV is provided
            if (!values.loanAmount && !values.ltv) {
                document.getElementById('loanAmountError').textContent = 'Either Loan Amount or LTV is required';
                document.getElementById('ltvError').textContent = 'Either Loan Amount or LTV is required';
                isValid = false;
            }

            // Validate FICO
            if (!values.fico) {
                document.getElementById('ficoError').textContent = 'FICO score is required';
                isValid = false;
            } else if (parseInt(values.fico) < 300 || parseInt(values.fico) > 850) {
                document.getElementById('ficoError').textContent = 'FICO score must be between 300 and 850';
                isValid = false;
            }

            // Validate State
            if (!values.state) {
                document.getElementById('stateError').textContent = 'State is required';
                isValid = false;
            }

            if (isValid) {
                const purchasePrice = parseFloat(values.purchasePrice.replace(/,/g, ''));
                const results = {
                    purchasePrice: purchasePrice,
                    fico: parseInt(values.fico),
                    propertyType: document.getElementById('propertyType').value,
                    state: values.state
                };

                if (values.loanAmount) {
                    results.loanAmount = parseFloat(values.loanAmount.replace(/,/g, ''));
                }
                if (values.ltv) {
                    results.ltv = parseFloat(values.ltv);
                }

                // Calculate missing value if needed
                if (!values.loanAmount && values.ltv) {
                    results.loanAmount = (purchasePrice * (parseFloat(values.ltv) / 100));
                }
                if (!values.ltv && values.loanAmount) {
                    results.ltv = ((results.loanAmount / purchasePrice) * 100).toFixed(2);
                }

                // Display results
                document.getElementById('resultLoanAmount').textContent = `Loan Amount: $${results.loanAmount.toLocaleString()}`;
                document.getElementById('resultPurchasePrice').textContent = `Purchase Price: $${results.purchasePrice.toLocaleString()}`;
                document.getElementById('resultLTV').textContent = `LTV: ${results.ltv}%`;
                document.getElementById('resultFICO').textContent = `FICO Score: ${results.fico}`;
                document.getElementById('resultPropertyType').textContent = `Property Type: ${results.propertyType.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ')}`;
                document.getElementById('resultState').textContent = `State: ${results.state}`;

                // Show results section
                document.getElementById('results').classList.add('show');
            }
        });

        document.getElementById('searchButton').addEventListener('click', displayMatchingLoans);


        
        async function displayMatchingLoans() {
  const loanTypeInput = document.getElementById('loanType');
  const matchingLoanTypesInput = document.getElementById('matchingLoanTypes');
  const loanType = loanTypeInput.value.trim();

  try {
    // Load the pricing data from PricingService
    await PricingService.loadLocalData();

    // Find the matching loan types
    const matchingLoans = PricingService.localData.filter(loan => {
      return loan.Product.startsWith(loanType);
    });

    // Display the matching loan types
    if (matchingLoans.length > 0) {
      const matchingLoanTypesText = matchingLoans.map(loan => loan.Product).join(', ');
      matchingLoanTypesInput.textContent = matchingLoanTypesText;
    } else {
      matchingLoanTypesInput.textContent = 'No matching loan types found.';
    }

    // Show the matching loans table
    document.getElementById('matchingLoansTable').style.display = 'block';
  } catch (error) {
    console.error('Error loading pricing data:', error);
  }
}
    </script>
    <script type="module" src="pricingService.js"></script>

</body>
</html>